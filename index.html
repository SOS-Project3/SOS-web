<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOS BBQ Monitor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Hamburger button -->
  <button id="navToggle" class="hamburger" aria-label="Open navigation" aria-controls="navDrawer" aria-expanded="false">
    <span></span><span></span><span></span>
  </button>

  <!-- Slide-in navigation drawer -->
  <nav id="navDrawer" class="nav-drawer" aria-hidden="true">
    <h3 class="nav-title">Navigate</h3>
    <ul>
      <li><a href="#section-project" class="nav-link">1) Project: Name & Description</a></li>
      <li><a href="#section-device" class="nav-link">2) Device ID & Explanation</a></li>
      <!-- IMPORTANT: clicking Live Data will first send preferences (if ready) -->
      <li><a href="#section-live" class="nav-link" data-requires-send="true">3) Live Data (ESP32 â†’ Web)</a></li>
      <li><a href="#section-prefs" class="nav-link">4) Set Preferences</a></li>
    </ul>
  </nav>
  <div id="backdrop" class="backdrop hidden" tabindex="-1" aria-hidden="true"></div>

  <div class="container">
    <h1 id="section-project">SOS BBQ Monitor</h1>

    <div class="project-section">
      <p class="muted"><strong>SOS: Smart Oven & Skewer</strong> â€” monitor and control BBQ cooking. Connects to an ESP32 via Firebase for live data and commands.</p>
    </div>

    <!-- Device ID -->
    <section id="section-device" class="device-section" aria-labelledby="device-id-title">
      <h2 id="device-id-title">Enter Device ID</h2>
      <input type="text" id="deviceIDInput" placeholder="Type device ID here" />
      <button id="setDeviceBtn">Set Device</button>
      <p id="deviceConfirmation" class="hidden alert"></p>

      <div class="info-box">
        <strong>What is the Device ID?</strong>
        <p>Itâ€™s the unique identifier your ESP32 writes under <code>/devices/{deviceId}</code> in Firebase Realtime Database.</p>
      </div>
    </section>

    <!-- Live Data -->
    <section id="section-live" class="live-section" aria-labelledby="live-data-title">
      <h2 id="live-data-title">Live Data</h2>
      <p><strong>Temperature:</strong> <span id="temp">--</span> Â°C <small id="tempAt" class="muted"></small></p>
      <p><strong>Status:</strong> <span id="status">--</span> <small id="statusAt" class="muted"></small></p>
      <p><strong>ESP Connection:</strong> <span id="connection">--</span> <small id="connAt" class="muted"></small></p>
      <p><strong>WiFi Speed:</strong> <span id="wifiSpeed">--</span> ms <small id="wifiAt" class="muted"></small></p>
    </section>

    <!-- Preferences -->
    <section id="section-prefs" class="control-section" aria-labelledby="preferences-title">
      <h2 id="preferences-title">Set Preferences</h2>

      <label for="meatSelect">Meat Type:</label>
      <select id="meatSelect" disabled>
        <option value="" disabled selected>Select meat</option>
        <option value="Chicken">Chicken</option>
        <option value="Tri tip">Tri tip</option>
        <option value="Knuckle">Knuckle</option>
        <option value="Flap">Flap</option>
        <option value="Top round">Top round</option>
        <option value="Top sirloin">Top sirloin</option>
        <option value="Flank">Flank</option>
        <option value="Sirloin cap">Sirloin cap</option>
        <option value="Chuck / teres major">Chuck / teres major</option>
        <option value="Steak cut / strip loin">Steak cut / strip loin</option>
        <option value="Rib / ribeye">Rib / ribeye</option>
        <option value="Flat iron">Flat iron</option>
      </select>

      <label for="donenessSelect">Doneness:</label>
      <select id="donenessSelect" disabled>
        <option value="" disabled selected>Select doneness</option>
        <option value="Rare">Rare</option>
        <option value="Medium Rare">Medium Rare</option>
        <option value="Medium">Medium</option>
        <option value="Medium Well">Medium Well</option>
        <option value="Well Done">Well Done</option>
      </select>

      <p id="donenessNote" class="hidden note">Chicken is always cooked Well Done.</p>

      <div class="buttons">
        <button id="startBtn" disabled>Start</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>

      <p id="confirmation" class="hidden alert"></p>
    </section>
  </div>

  <!-- Firebase SDKs + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXDxynz9AKrexXIUmvza8xnPA2HriiePQ",
      authDomain: "sos-project-23171.firebaseapp.com",
      databaseURL: "https://sos-project-23171-default-rtdb.firebaseio.com",
      projectId: "sos-project-23171",
      storageBucket: "sos-project-23171.firebasestorage.app",
      messagingSenderId: "739080997565",
      appId: "1:739080997565:web:8794ee9ba4f4f27de4c5d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ----- DOM
    const deviceInput = document.getElementById("deviceIDInput");
    const setDeviceBtn = document.getElementById("setDeviceBtn");
    const deviceConfirmation = document.getElementById("deviceConfirmation");

    const meatSelect = document.getElementById("meatSelect");
    const donenessSelect = document.getElementById("donenessSelect");
    const donenessNote = document.getElementById("donenessNote");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    const tempSpan = document.getElementById("temp");
    const statusSpan = document.getElementById("status");
    const connectionSpan = document.getElementById("connection");
    const wifiSpeedSpan = document.getElementById("wifiSpeed");
    const confirmText = document.getElementById("confirmation");

    const tempAt = document.getElementById("tempAt");
    const statusAt = document.getElementById("statusAt");
    const connAt = document.getElementById("connAt");
    const wifiAt = document.getElementById("wifiAt");

    const navToggle = document.getElementById("navToggle");
    const navDrawer = document.getElementById("navDrawer");
    const backdrop = document.getElementById("backdrop");
    const navLinks = document.querySelectorAll(".nav-link");

    // ----- State
    let currentDeviceID = null;
    const LS = {
      device: "sos_device_id",
      meat: "sos_meat",
      doneness: "sos_doneness",
    };

    // ----- Helpers
    function enableControls(enabled) {
      meatSelect.disabled = !enabled;
      donenessSelect.disabled = !enabled;
      startBtn.disabled = !enabled;
      stopBtn.disabled = !enabled;
    }
    function stamp(el) { if (el) el.textContent = `(updated ${new Date().toLocaleTimeString()})`; }

    function updateDonenessForMeat() {
      const meat = meatSelect.value;
      if (meat === "Chicken") {
        donenessSelect.value = "Well Done";
        donenessSelect.disabled = true;
        donenessNote.classList.remove("hidden");
      } else {
        donenessSelect.disabled = false;
        donenessNote.classList.add("hidden");
        if (donenessSelect.value === "Well Done") donenessSelect.value = "";
      }
    }

    function saveSelections() {
      localStorage.setItem(LS.meat, meatSelect.value || "");
      localStorage.setItem(LS.doneness, donenessSelect.value || "");
    }
    function restoreSelections() {
      const meat = localStorage.getItem(LS.meat) || "";
      const done = localStorage.getItem(LS.doneness) || "";
      if (meat) meatSelect.value = meat;
      updateDonenessForMeat();
      if (done) donenessSelect.value = done;
    }

    function setCurrentDevice(id) {
      currentDeviceID = id;
      deviceConfirmation.classList.remove("hidden");
      deviceConfirmation.textContent = `Device ID set to: ${currentDeviceID}`;
      localStorage.setItem(LS.device, currentDeviceID);
      enableControls(true);
      setupDeviceRefs(currentDeviceID);
    }

    async function sendPreferencesIfReady(showToast = true) {
      const meat = meatSelect.value;
      const doneness = donenessSelect.value;

      // Only send if everything is ready
      if (!currentDeviceID || !meat || !doneness) return false;

      try {
        await update(ref(db, `devices/${currentDeviceID}/settings`), {
          meatType: meat,
          doneness: doneness
        });
        if (showToast) {
          confirmText.classList.remove("hidden");
          confirmText.textContent = `âœ… Preferences sent: ${meat} - ${doneness}`;
          setTimeout(() => confirmText.classList.add("hidden"), 2000);
        }
        return true;
      } catch (e) {
        alert("Error sending preferences: " + e.message);
        return false;
      }
    }

    // ----- NAV drawer behavior
    function openNav() {
      navDrawer.classList.add("open");
      backdrop.classList.remove("hidden");
      navToggle.setAttribute("aria-expanded", "true");
      navDrawer.setAttribute("aria-hidden", "false");
      document.body.classList.add("no-scroll");
    }
    function closeNav() {
      navDrawer.classList.remove("open");
      backdrop.classList.add("hidden");
      navToggle.setAttribute("aria-expanded", "false");
      navDrawer.setAttribute("aria-hidden", "true");
      document.body.classList.remove("no-scroll");
    }
    navToggle.addEventListener("click", () => {
      if (navDrawer.classList.contains("open")) closeNav(); else openNav();
    });
    backdrop.addEventListener("click", closeNav);

    // Intercept clicks to Live Data: send preferences first, then navigate
    navLinks.forEach(a => {
      a.addEventListener("click", async (e) => {
        const targetHash = a.getAttribute("href") || "#";
        const mustSend = a.dataset.requiresSend === "true";

        // Close drawer immediately for UX
        closeNav();

        if (mustSend) {
          e.preventDefault(); // hold navigation
          await sendPreferencesIfReady(true);
          // then navigate to the section
          const el = document.querySelector(targetHash);
          if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
          else window.location.hash = targetHash;
        }
        // else allow normal anchor navigation
      });
    });

    // ----- Doneness logic + persistence
    meatSelect.addEventListener("change", () => { updateDonenessForMeat(); saveSelections(); });
    donenessSelect.addEventListener("change", saveSelections);

    // ----- Device set/restore
    const savedDevice = localStorage.getItem(LS.device);
    if (savedDevice) {
      deviceInput.value = savedDevice;
      const deviceRef = ref(db, `devices/${savedDevice}`);
      get(deviceRef).then(snap => { if (snap.exists()) setCurrentDevice(savedDevice); });
    }
    restoreSelections();

    setDeviceBtn.addEventListener("click", () => {
      const id = deviceInput.value.trim();
      if (!id) { alert("Please enter a device ID."); return; }
      const deviceRef = ref(db, `devices/${id}`);
      get(deviceRef).then(snapshot => {
        if (snapshot.exists()) {
          setCurrentDevice(id);
        } else {
          alert("Device ID not found in Firebase. Please check and try again.");
        }
      }).catch(error => {
        alert("Error checking device ID: " + error.message);
      });
    });

    // ----- Live subscriptions
    function setupDeviceRefs(deviceID) {
      const tempRef = ref(db, `devices/${deviceID}/liveData/temperature`);
      const statusRef = ref(db, `devices/${deviceID}/liveData/status`);
      const connectionRef = ref(db, `devices/${deviceID}/liveData/isConnected`);
      const wifiSpeedRef = ref(db, `devices/${deviceID}/liveData/wifiSpeed`);

      onValue(tempRef, (snap) => { tempSpan.textContent = snap.val() ?? "--"; stamp(tempAt); });
      onValue(statusRef, (snap) => { statusSpan.textContent = snap.val() ?? "--"; stamp(statusAt); });
      onValue(connectionRef, (snap) => { connectionSpan.textContent = snap.val() ? "Connected âœ…" : "Disconnected âš "; stamp(connAt); });
      onValue(wifiSpeedRef, (snap) => { wifiSpeedSpan.textContent = snap.val() ?? "--"; stamp(wifiAt); });
    }

    // ----- Start/Stop (also sends prefs on Start)
    startBtn.addEventListener("click", async () => {
      if (!currentDeviceID) { alert("Set device ID first."); return; }
      if (!meatSelect.value || !donenessSelect.value) { alert("Select both meat type and doneness."); return; }

      await sendPreferencesIfReady(false); // ensure prefs are up to date
      update(ref(db, `devices/${currentDeviceID}/settings`), { command: "start" })
        .then(() => {
          confirmText.classList.remove("hidden");
          confirmText.textContent = `ðŸ”¥ Cooking started: ${meatSelect.value} - ${donenessSelect.value}`;
          setTimeout(() => { confirmText.classList.add("hidden"); }, 3000);
        })
        .catch(err => alert("Error: " + err.message));
    });

    stopBtn.addEventListener("click", () => {
      if (!currentDeviceID) return;
      update(ref(db, `devices/${currentDeviceID}/settings`), { command: "stop" })
        .then(() => {
          confirmText.classList.remove("hidden");
          confirmText.textContent = "ðŸ›‘ Cooking stopped.";
          setTimeout(() => { confirmText.classList.add("hidden"); }, 3000);
        })
        .catch(err => alert("Error: " + err.message));
    });
  </script>
</body>
</html>
