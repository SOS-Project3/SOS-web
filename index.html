<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1"
  />
  <title>SOS BBQ Monitor (Static)</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Always-visible navigation button -->
  <button id="menuToggle" class="hamburger" aria-label="Open navigation">
    <span></span><span></span><span></span>
  </button>

  <nav id="sideMenu" class="side-menu hidden" aria-hidden="true">
    <ul>
      <li><a href="#page1" data-nav>1) Project Description</a></li>
      <li><a href="#page2" data-nav>2) Device Alias</a></li>
      <li><a href="#page3" data-nav>3) Live Data</a></li>
      <li><a href="#page4" data-nav>4) Set Preferences</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- Page 1 -->
    <section id="page1" class="page">
      <h1>SOS BBQ MONITOR</h1>
      <p><strong>SOS: Smart Oven &amp; Skewer</strong> ‚Äî fully static demo (no backend). Set per-tip meat &amp; doneness, simulate live temps, and track progress to target.</p>
      <ul class="bullets">
        <li>Strict 4√ó2 tip mapping that stays 2-column on phones</li>
        <li><strong>Skewer Mode</strong>: Chicken (locked Well Done) or Meat (free per tip)</li>
        <li>Apply to all tips (Meat mode only)</li>
        <li>Temperature simulator + ‚Äútarget reached‚Äù modal</li>
      </ul>
    </section>

    <!-- Page 2: Device Alias (local only) -->
    <section id="page2" class="page hidden">
      <h2>Device Alias</h2>
      <input type="text" id="deviceAliasInput" placeholder="Enter a nickname (local only)" />
      <button id="setAliasBtn">Set Alias</button>
      <p id="aliasConfirmation" class="hidden success-text"></p>
    </section>

    <!-- Page 3: Live Data (simulated) -->
    <section id="page3" class="page hidden">
      <h2>Live Data</h2>

      <div class="sim-bar" role="group" aria-label="Simulation controls">
        <button id="startSimBtn" class="btn-start">Start Simulation</button>
        <button id="stopSimBtn" class="btn-stop" disabled>Stop</button>

        <label class="sim-ctrl">
          Tick (ms)
          <input type="number" id="simTickMs" min="100" step="50" value="600" />
        </label>
        <label class="sim-ctrl">
          Heat rate (¬∞C/s)
          <input type="number" id="simRate" min="0.1" step="0.1" value="0.6" />
        </label>
      </div>

      <div class="tips-grid" id="liveGrid"></div>
    </section>

    <!-- Page 4: Set Preferences -->
    <section id="page4" class="page hidden">
      <h2>Set Preferences</h2>

      <!-- Skewer Mode -->
      <div class="mode-bar" role="group" aria-label="Skewer mode">
        <label class="mode-title">Skewer Mode</label>
        <label class="mode-pill">
          <input type="radio" name="skMode" id="modeChicken" value="chicken">
          Chicken (locked Well Done)
        </label>
        <label class="mode-pill">
          <input type="radio" name="skMode" id="modeMeat" value="meat">
          Meat (choose per tip)
        </label>
      </div>

      <p class="note-orange">
        In <strong>Chicken</strong> mode, all tips are fixed to <strong>Chicken ‚Ä¢ Well Done</strong> and per-tip controls are disabled.
        Switch to <strong>Meat</strong> mode to choose meats/doneness per tip or use <em>Apply to all</em>.
      </p>

      <!-- Apply-to-all controls (Meat mode only) -->
      <div class="bulk-controls">
        <label class="bulk-label">Apply to all tips</label>
        <select id="bulkMeat"></select>
        <select id="bulkDone"></select>
        <button id="bulkApplyBtn" class="btn-apply" disabled>Apply to all</button>
      </div>

      <div class="tips-grid" id="prefsGrid"></div>

      <div class="buttons">
        <button id="startAllBtn" class="btn-start">Start Cooking (All)</button>
        <button id="stopAllBtn" class="btn-stop">Stop (All)</button>
      </div>

      <p id="confirmation" class="hidden success-text"></p>
    </section>
  </div>

  <!-- Cooking Complete Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <h3 id="modalTitle">Cooking Complete</h3>
      <p id="modalMsg">Tip X reached target temperature.</p>
      <button id="modalClose" class="btn-primary">Close</button>
    </div>
  </div>

  <!-- ====================== EMBEDDED JS ====================== -->
  <script>
    /* -------------------- Constants & State -------------------- */
    const ALL_TIPS = [1,2,3,4,5,6,7,8];
    const TIP_ROWS = [[4,8],[3,7],[2,6],[1,5]]; // left/right mapping
    const MEATS = [
      "Chicken","Tri tip","Knuckle","Flap","Top round","Top sirloin","Flank",
      "Sirloin cap","Chuck / teres major","Steak cut / strip loin","Rib / ribeye","Flat iron"
    ];
    const NON_CHICKEN_MEATS = MEATS.filter(m => m !== "Chicken");
    const DONENESS = ["Rare","Medium Rare","Medium","Medium Well","Well Done"];

    const BASE_TARGETS = { "Rare":51, "Medium Rare":55, "Medium":60, "Medium Well":67, "Well Done":72 };
    const TARGET_MAP = new Map();
    MEATS.forEach(m => { if (m !== "Chicken") TARGET_MAP.set(m, {...BASE_TARGETS}); });
    TARGET_MAP.set("Chicken", { "Well Done": 74 });

    const SK_MODE = { CHICKEN: 'chicken', MEAT: 'meat' };
    let skewerMode = SK_MODE.MEAT; // default mode for static demo
    let simTimer = null;
    const tipSettings = {};  // { [tip]: { meatType, doneness } }
    const tipState = {};     // { [tip]: { temp, reachedShown } }

    /* -------------------- Element Handles -------------------- */
    const menuBtn = document.getElementById("menuToggle");
    const sideMenu = document.getElementById("sideMenu");
    const navLinks = document.querySelectorAll("[data-nav]");

    const deviceAliasInput = document.getElementById("deviceAliasInput");
    const setAliasBtn = document.getElementById("setAliasBtn");
    const aliasConfirmation = document.getElementById("aliasConfirmation");

    const liveGrid = document.getElementById("liveGrid");
    const prefsGrid = document.getElementById("prefsGrid");
    const startAllBtn = document.getElementById("startAllBtn");
    const stopAllBtn = document.getElementById("stopAllBtn");
    const confirmText = document.getElementById("confirmation");

    const bulkMeat = document.getElementById("bulkMeat");
    const bulkDone = document.getElementById("bulkDone");
    const bulkApplyBtn = document.getElementById("bulkApplyBtn");

    const modeChicken = document.getElementById("modeChicken");
    const modeMeat = document.getElementById("modeMeat");

    const startSimBtn = document.getElementById("startSimBtn");
    const stopSimBtn = document.getElementById("stopSimBtn");
    const simTickMs = document.getElementById("simTickMs");
    const simRate = document.getElementById("simRate");

    const modal = document.getElementById("modal");
    const modalMsg = document.getElementById("modalMsg");
    const modalClose = document.getElementById("modalClose");

    /* ------------------------- Utils ------------------------- */
    const show = el => el.classList.remove("hidden");
    const hide = el => el.classList.add("hidden");
    const el  = (t,c)=>{const e=document.createElement(t); if(c) e.className=c; return e;};
    const isChicken = (m) => (m||"").toLowerCase() === "chicken";
    const targetTempFor = (meat,done)=>TARGET_MAP.get(meat)?.[done] || null;
    const clamp01 = (v)=> Math.max(0, Math.min(1, v));
    const toastOk = (msg)=>{ confirmText.textContent = msg; show(confirmText); setTimeout(()=>hide(confirmText), 1600); };

    function buildDonenessOptions(sel, selected=null) {
      sel.innerHTML = "";
      DONENESS.forEach(d=>{
        const o=document.createElement("option");
        o.value=d; o.textContent=d;
        if (selected && selected===d) o.selected=true;
        sel.appendChild(o);
      });
    }

    function populateSelect(sel, arr) {
      sel.innerHTML = "";
      arr.forEach(v => {
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      });
    }

    /* -------------------- Navigation -------------------- */
    menuBtn.addEventListener("click",()=>{
      sideMenu.classList.toggle("hidden");
      const nowHidden = sideMenu.classList.contains("hidden");
      sideMenu.setAttribute("aria-hidden", nowHidden ? "true" : "false");
    });

    navLinks.forEach(link=>{
      link.addEventListener("click",e=>{
        e.preventDefault();
        document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
        document.querySelector(link.getAttribute("href")).classList.remove("hidden");
        sideMenu.classList.add("hidden");
        sideMenu.setAttribute("aria-hidden","true");
      });
    });

    /* -------------------- Build Grids -------------------- */
    function buildLiveGrid(){
      liveGrid.innerHTML="";
      TIP_ROWS.forEach(([L,R])=>{
        const row=el("div","tips-row");
        [L,R].forEach(t=>{
          const card=el("div","tip-card");
          card.innerHTML=`
            <div class="tip-header">
              <span class="tip-badge">Tip ${t}</span>
              <span class="tip-label"><span id="liveMeat${t}">--</span> ‚Ä¢ <span id="liveDone${t}">--</span></span>
            </div>
            <p class="tip-line"><strong>Temp:</strong> <span id="temp${t}">--</span> ¬∞C</p>
            <p class="tip-line"><strong>Target:</strong> <span id="target${t}">--</span> ¬∞C</p>
            <div class="progress">
              <div id="pbar${t}" class="progress-bar"></div>
              <span id="plabel${t}" class="progress-label">--%</span>
            </div>`;
          row.appendChild(card);
        });
        liveGrid.appendChild(row);
      });
    }

    function buildPrefsGrid(){
      prefsGrid.innerHTML="";
      TIP_ROWS.forEach(([L,R])=>{
        const row=el("div","tips-row");
        [L,R].forEach(t=>{
          const card=el("div","tip-card");
          const header=el("div","tip-header");
          header.innerHTML = `<span class="tip-badge">Tip ${t}</span>`;

          const meatSel=el("select"); meatSel.id=`meat${t}`;
          const doneSel=el("select"); doneSel.id=`done${t}`;

          // Default populate
          populateSelect(meatSel, MEATS);
          buildDonenessOptions(doneSel, "Medium");

          const btn=el("button","btn-apply"); 
          btn.id = `applyBtn${t}`;
          btn.textContent="Apply";

          btn.addEventListener("click", ()=>{
            if (skewerMode === SK_MODE.CHICKEN) {
              alert("Skewer is in Chicken mode. Switch to Meat mode to change tips.");
              return;
            }
            const chosenMeat = meatSel.value;
            const chosenDone = isChicken(chosenMeat) ? "Well Done" : doneSel.value;

            // Save locally
            tipSettings[t] = { meatType: chosenMeat, doneness: chosenDone };
            // Reflect to Live labels + target
            document.getElementById(`liveMeat${t}`).textContent = chosenMeat;
            document.getElementById(`liveDone${t}`).textContent = chosenDone;
            document.getElementById(`target${t}`).textContent = targetTempFor(chosenMeat, chosenDone) ?? "--";

            toastOk(`Tip ${t}: ${chosenMeat} ‚Ä¢ ${chosenDone} saved`);
          });

          card.appendChild(header);
          card.appendChild(meatSel);
          card.appendChild(doneSel);
          card.appendChild(btn);
          row.appendChild(card);
        });
        prefsGrid.appendChild(row);
      });
    }

    /* -------------------- Mode Handling -------------------- */
    function applyModeUI(){
      // Radios reflect state
      modeChicken.checked = (skewerMode === SK_MODE.CHICKEN);
      modeMeat.checked    = (skewerMode === SK_MODE.MEAT);

      // Per-tip UI
      ALL_TIPS.forEach(t=>{
        const meatSel = document.getElementById(`meat${t}`);
        const doneSel = document.getElementById(`done${t}`);
        const applyBtn= document.getElementById(`applyBtn${t}`);
        if (!meatSel || !doneSel) return;

        if (skewerMode === SK_MODE.CHICKEN) {
          // Force Chicken/WD, lock controls, update labels + targets
          meatSel.innerHTML = `<option value="Chicken">Chicken</option>`;
          meatSel.value = "Chicken";
          meatSel.disabled = true;

          doneSel.innerHTML = "<option value='Well Done'>Well Done</option>";
          doneSel.value = "Well Done";
          doneSel.disabled = true;

          if (applyBtn) applyBtn.disabled = true;

          tipSettings[t] = { meatType: "Chicken", doneness: "Well Done" };
          document.getElementById(`liveMeat${t}`).textContent = "Chicken";
          document.getElementById(`liveDone${t}`).textContent = "Well Done";
          document.getElementById(`target${t}`).textContent = targetTempFor("Chicken","Well Done") ?? "--";
        } else {
          // Enable per-tip, remove Chicken option
          meatSel.disabled = false;
          doneSel.disabled = false;
          meatSel.innerHTML = "";
          NON_CHICKEN_MEATS.forEach(m=>{
            const o=document.createElement("option");
            o.value=m; o.textContent=m; meatSel.appendChild(o);
          });
          // keep previous selection if valid
          const prev = tipSettings[t]?.meatType;
          if (prev && !isChicken(prev) && NON_CHICKEN_MEATS.includes(prev)) {
            meatSel.value = prev;
          }
          buildDonenessOptions(doneSel, tipSettings[t]?.doneness || "Medium");
          if (applyBtn) applyBtn.disabled = false;

          // Live labels remain whatever the user set; no forced change
        }
      });

      // Bulk controls
      if (skewerMode === SK_MODE.CHICKEN) {
        bulkMeat.innerHTML = `<option value="Chicken">Chicken</option>`;
        bulkDone.innerHTML = "<option value='Well Done'>Well Done</option>";
        bulkMeat.disabled = true;
        bulkDone.disabled = true;
        bulkApplyBtn.disabled = true;
      } else {
        bulkMeat.disabled = false;
        bulkDone.disabled = false;
        bulkApplyBtn.disabled = false;
        populateSelect(bulkMeat, NON_CHICKEN_MEATS);
        populateSelect(bulkDone, DONENESS);
      }
    }

    async function setMode(mode){
      if (mode !== SK_MODE.CHICKEN && mode !== SK_MODE.MEAT) return;
      skewerMode = mode;
      if (mode === SK_MODE.CHICKEN) {
        // Force all tips instantly
        ALL_TIPS.forEach(t=>{
          tipSettings[t] = { meatType:"Chicken", doneness:"Well Done" };
          document.getElementById(`liveMeat${t}`).textContent = "Chicken";
          document.getElementById(`liveDone${t}`).textContent = "Well Done";
          document.getElementById(`target${t}`).textContent = targetTempFor("Chicken","Well Done") ?? "--";
        });
        toastOk("Skewer set to Chicken mode (all tips locked to Chicken ‚Ä¢ Well Done).");
      } else {
        toastOk("Skewer set to Meat mode (per-tip choices enabled).");
      }
      applyModeUI();
    }

    // Mode radio listeners
    modeChicken.addEventListener("change",(e)=>{ if (e.target.checked) setMode(SK_MODE.CHICKEN); });
    modeMeat.addEventListener("change",(e)=>{ if (e.target.checked) setMode(SK_MODE.MEAT); });

    /* -------------------- Bulk Apply (Meat mode) -------------------- */
    bulkApplyBtn.addEventListener("click", ()=>{
      if (skewerMode === SK_MODE.CHICKEN) {
        alert("Skewer is in Chicken mode. Switch to Meat mode to apply settings.");
        return;
      }
      const meat = bulkMeat.value;
      const done = bulkDone.value;

      ALL_TIPS.forEach(t=>{
        // Update selects
        const meatSel = document.getElementById(`meat${t}`);
        const doneSel = document.getElementById(`done${t}`);
        if (meatSel) meatSel.value = meat;
        if (doneSel) {
          doneSel.disabled = false;
          buildDonenessOptions(doneSel, done);
        }
        // Save locally + reflect live targets
        tipSettings[t] = { meatType: meat, doneness: done };
        document.getElementById(`liveMeat${t}`).textContent = meat;
        document.getElementById(`liveDone${t}`).textContent = done;
        document.getElementById(`target${t}`).textContent = targetTempFor(meat, done) ?? "--";
      });
      toastOk(`Applied to all tips: ${meat} ‚Ä¢ ${done}`);
    });

    /* -------------------- Device Alias (local only) -------------------- */
    const LS_ALIAS = "sos_device_alias";
    setAliasBtn.addEventListener("click", ()=>{
      const alias=(deviceAliasInput.value||"").trim();
      if (!alias) return alert("Enter an alias");
      localStorage.setItem(LS_ALIAS, alias);
      aliasConfirmation.textContent=`Alias set: ${alias}`;
      show(aliasConfirmation);
      setTimeout(()=>hide(aliasConfirmation),1600);
    });
    const savedAlias = localStorage.getItem(LS_ALIAS);
    if (savedAlias) {
      deviceAliasInput.value = savedAlias;
    }

    /* -------------------- Simulator -------------------- */
    function initTipState(){
      ALL_TIPS.forEach(t=>{
        // Start around room temp with small variance
        const base = 23 + (Math.random()*3 - 1.5);
        tipState[t] = { temp: base, reachedShown: false };
      });
    }

    function currentTargetForTip(t){
      const { meatType, doneness } = tipSettings[t] || {};
      if (!meatType || !doneness) return null;
      return targetTempFor(meatType, doneness);
    }

    function tickSim(){
      const ratePerSec = Math.max(0.05, Number(simRate.value) || 0.6); // ¬∞C/s
      const dt = Math.max(0.05, (Number(simTickMs.value)||600)/1000);  // s per tick

      ALL_TIPS.forEach(t=>{
        const st = tipState[t];
        const tgt = currentTargetForTip(t);
        let cur = st.temp;

        // Heat if below target; add tiny noise
        if (tgt && cur < tgt) {
          const approach = (tgt - cur);
          const gain = ratePerSec * dt * (0.35 + 0.65 * clamp01(approach / 50)); // gentle taper
          cur += gain + (Math.random()*0.12 - 0.06);
          if (cur > tgt) cur = tgt;
        } else {
          // idle drift
          cur += (Math.random()*0.06 - 0.03);
        }

        st.temp = cur;

        // Update UI
        document.getElementById(`temp${t}`).textContent = cur.toFixed(1);

        const bar = document.getElementById(`pbar${t}`);
        const lab = document.getElementById(`plabel${t}`);
        if (tgt && bar && lab) {
          const pct = Math.round(clamp01(cur / tgt) * 100);
          bar.style.width = pct + "%";
          lab.textContent = pct + "%";

          if (cur >= tgt && !st.reachedShown) {
            st.reachedShown = true;
            openModal(`Tip ${t} reached target temperature (${tgt}¬∞C).`);
          }
        } else if (bar && lab) {
          bar.style.width = "0%";
          lab.textContent = "--%";
        }
      });
    }

    function startSim(){
      if (simTimer) return;
      const ms = Math.max(100, Number(simTickMs.value)||600);
      simTimer = setInterval(tickSim, ms);
      startSimBtn.disabled = true;
      stopSimBtn.disabled = false;
    }

    function stopSim(){
      if (!simTimer) return;
      clearInterval(simTimer);
      simTimer = null;
      startSimBtn.disabled = false;
      stopSimBtn.disabled = true;
    }

    startSimBtn.addEventListener("click", startSim);
    stopSimBtn.addEventListener("click", stopSim);
    simTickMs.addEventListener("change", ()=>{
      if (simTimer) { stopSim(); startSim(); }
    });

    /* -------------------- Start/Stop (All) -------------------- */
    startAllBtn.addEventListener("click", ()=>{
      // Reset ‚Äúreached‚Äù and jump to Live Data
      ALL_TIPS.forEach(t=> tipState[t].reachedShown = false );
      document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
      document.getElementById("page3").classList.remove("hidden");
      toastOk("üî• Cooking started (simulation running)");
      startSim();
    });

    stopAllBtn.addEventListener("click", ()=>{
      stopSim();
      toastOk("üõë Cooking stopped");
    });

    /* -------------------- Modal -------------------- */
    function openModal(msg){ modalMsg.textContent = msg; show(modal); }
    modalClose.addEventListener("click",()=>hide(modal));
    modal.addEventListener("click",(e)=>{ if(e.target === modal) hide(modal); });
    document.addEventListener("keydown",(e)=>{ if(e.key === "Escape") hide(modal); });

    /* -------------------- Bootstrap -------------------- */
    function bootstrapDefaults(){
      // Initial reasonable defaults per mode
      ALL_TIPS.forEach(t=>{
        if (skewerMode === SK_MODE.CHICKEN) {
          tipSettings[t] = { meatType: "Chicken", doneness: "Well Done" };
        } else {
          tipSettings[t] = { meatType: "Tri tip", doneness: "Medium" };
        }
      });
    }

    function reflectSettingsToLive(){
      ALL_TIPS.forEach(t=>{
        const { meatType, doneness } = tipSettings[t];
        document.getElementById(`liveMeat${t}`).textContent = meatType;
        document.getElementById(`liveDone${t}`).textContent = doneness;
        document.getElementById(`target${t}`).textContent = targetTempFor(meatType, doneness) ?? "--";
      });
    }

    buildLiveGrid();
    buildPrefsGrid();
    bootstrapDefaults();
    reflectSettingsToLive();
    applyModeUI();
    initTipState();
  </script>
</body>
</html>
