<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOS BBQ Monitor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Hamburger navigation -->
  <button id="menuToggle" class="hamburger">
    <span></span><span></span><span></span>
  </button>

  <nav id="sideMenu" class="side-menu hidden">
    <ul>
      <li><a href="#page1">1) Project Description</a></li>
      <li><a href="#page2">2) Device ID</a></li>
      <li><a href="#page3">3) Live Data</a></li>
      <li><a href="#page4">4) Set Preferences</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- Page 1 -->
    <section id="page1" class="page active">
      <h1>SOS BBQ MONITOR</h1>
      <p><strong>SOS: Smart Oven & Skewer</strong> â€” a senior design project that monitors and controls BBQ cooking using an ESP32 connected to Firebase.</p>
    </section>

    <!-- Page 2 -->
    <section id="page2" class="page hidden">
      <h2>Device ID</h2>
      <input type="text" id="deviceIDInput" placeholder="Enter device ID" />
      <button id="setDeviceBtn">Set Device</button>
      <p id="deviceConfirmation" class="hidden success-text"></p>
    </section>

    <!-- Page 3 -->
    <section id="page3" class="page hidden">
      <h2>Live Data</h2>
      <p><strong>Temperature:</strong> <span id="temp">--</span> Â°C</p>
      <p><strong>Status:</strong> <span id="status">--</span></p>
      <p><strong>ESP Connection:</strong> <span id="connection">--</span></p>
      <p><strong>WiFi Speed:</strong> <span id="wifiSpeed">--</span> ms</p>
    </section>

    <!-- Page 4 -->
    <section id="page4" class="page hidden">
      <h2>Set Preferences</h2>
      <label for="meatSelect">Meat Type:</label>
      <select id="meatSelect" disabled>
        <option value="" disabled selected>Select meat</option>
        <option value="Chicken">Chicken</option>
        <option value="Beef">Beef</option>
        <option value="Lamb">Lamb</option>
        <option value="Fish">Fish</option>
      </select>

      <label for="donenessSelect">Doneness:</label>
      <select id="donenessSelect" disabled>
        <option value="" disabled selected>Select doneness</option>
        <option value="Rare">Rare</option>
        <option value="Medium">Medium</option>
        <option value="Well Done">Well Done</option>
      </select>

      <p id="donenessNote" class="hidden success-text">Chicken is always cooked Well Done.</p>

      <div class="buttons">
        <button id="startBtn" disabled>Start</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>

      <p id="confirmation" class="hidden success-text"></p>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCXDxynz9AKrexXIUmvza8xnPA2HriiePQ",
      authDomain: "sos-project-23171.firebaseapp.com",
      databaseURL: "https://sos-project-23171-default-rtdb.firebaseio.com",
      projectId: "sos-project-23171",
      storageBucket: "sos-project-23171.firebasestorage.app",
      messagingSenderId: "739080997565",
      appId: "1:739080997565:web:8794ee9ba4f4f27de4c5d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ======== Elements ========
    const menuBtn = document.getElementById("menuToggle");
    const sideMenu = document.getElementById("sideMenu");
    const links = sideMenu.querySelectorAll("a");
    const deviceInput = document.getElementById("deviceIDInput");
    const setDeviceBtn = document.getElementById("setDeviceBtn");
    const deviceConfirmation = document.getElementById("deviceConfirmation");
    const tempSpan = document.getElementById("temp");
    const statusSpan = document.getElementById("status");
    const connectionSpan = document.getElementById("connection");
    const wifiSpeedSpan = document.getElementById("wifiSpeed");
    const meatSelect = document.getElementById("meatSelect");
    const donenessSelect = document.getElementById("donenessSelect");
    const donenessNote = document.getElementById("donenessNote");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const confirmText = document.getElementById("confirmation");

    let currentDeviceID = null;

    // ======== Navigation toggle ========
    menuBtn.addEventListener("click", () => sideMenu.classList.toggle("hidden"));
    links.forEach(link => {
      link.addEventListener("click", e => {
        e.preventDefault();
        const target = document.querySelector(link.getAttribute("href"));
        document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
        target.classList.remove("hidden");
        sideMenu.classList.add("hidden");
      });
    });

    // ======== Device setup ========
    setDeviceBtn.addEventListener("click", () => {
      const id = deviceInput.value.trim();
      if (!id) { alert("Enter a device ID"); return; }

      const deviceRef = ref(db, `devices/${id}`);
      get(deviceRef).then(snapshot => {
        if (snapshot.exists()) {
          currentDeviceID = id;
          deviceConfirmation.textContent = `Device set: ${id}`;
          deviceConfirmation.classList.remove("hidden");

          meatSelect.disabled = false;
          donenessSelect.disabled = false;
          startBtn.disabled = false;
          stopBtn.disabled = false;
          setupDeviceRefs(id);
        } else {
          alert("Device not found in Firebase");
        }
      });
    });

    // ======== Live Firebase data ========
    function setupDeviceRefs(deviceID) {
      onValue(ref(db, `devices/${deviceID}/liveData/temperature`), s => tempSpan.textContent = s.val() ?? "--");
      onValue(ref(db, `devices/${deviceID}/liveData/status`), s => statusSpan.textContent = s.val() ?? "--");
      onValue(ref(db, `devices/${deviceID}/liveData/isConnected`), s => connectionSpan.textContent = s.val() ? "Connected âœ…" : "Disconnected âš ");
      onValue(ref(db, `devices/${deviceID}/liveData/wifiSpeed`), s => wifiSpeedSpan.textContent = s.val() ?? "--");
    }

    // ======== Enforce Chicken -> Well Done ========
    meatSelect.addEventListener("change", () => {
      if (meatSelect.value === "Chicken") {
        donenessSelect.value = "Well Done";
        donenessSelect.disabled = true;
        donenessNote.classList.remove("hidden");
      } else {
        donenessSelect.disabled = false;
        donenessNote.classList.add("hidden");
        donenessSelect.value = "";
      }
    });

    // ======== Start / Stop cooking ========
    startBtn.addEventListener("click", () => {
      if (!currentDeviceID) return;
      const meat = meatSelect.value;
      const doneness = donenessSelect.value;
      if (!meat || !doneness) { alert("Select meat and doneness"); return; }

      update(ref(db, `devices/${currentDeviceID}/settings`), {
        meatType: meat,
        doneness,
        command: "start"
      }).then(() => {
        confirmText.textContent = `ðŸ”¥ Started: ${meat} - ${doneness}`;
        confirmText.classList.remove("hidden");
        setTimeout(() => confirmText.classList.add("hidden"), 2000);
      });
    });

    stopBtn.addEventListener("click", () => {
      if (!currentDeviceID) return;
      update(ref(db, `devices/${currentDeviceID}/settings`), { command: "stop" })
        .then(() => {
          confirmText.textContent = "ðŸ›‘ Stopped.";
          confirmText.classList.remove("hidden");
          setTimeout(() => confirmText.classList.add("hidden"), 2000);
        });
    });
  </script>
</body>
</html>
