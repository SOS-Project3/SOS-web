<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOS BBQ Monitor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Disconnected banner -->
  <div id="connBanner" class="banner hidden">‚ö†Ô∏è ESP disconnected</div>

  <!-- Always-visible navigation button -->
  <button id="menuToggle" class="hamburger" aria-label="Open navigation">
    <span></span><span></span><span></span>
  </button>

  <nav id="sideMenu" class="side-menu hidden" aria-hidden="true">
    <ul>
      <li><a href="#page1" data-nav>1) Project Description</a></li>
      <li><a href="#page2" data-nav>2) Device ID</a></li>
      <li><a href="#page3" data-nav>3) Live Data</a></li>
      <li><a href="#page4" data-nav>4) Set Preferences</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- Page 1 -->
    <section id="page1" class="page">
      <h1>SOS BBQ MONITOR</h1>
      <p><strong>SOS: Smart Oven &amp; Skewer</strong> ‚Äî monitor and control an 8-tip skewer powered by ESP32 + Firebase. Set per-tip meat &amp; doneness, see live temps, and track progress to target.</p>
      <ul class="bullets">
        <li>Strict 4√ó2 tip mapping that stays 2-column on phones</li>
        <li><strong>Skewer Mode</strong>: Chicken (locked Well Done) or Meat (per-tip)</li>
        <li><strong>No mixing:</strong> Chicken vs Meat is a global mode</li>
        <li><strong>Apply to All</strong> works only in Meat mode and updates both pages instantly</li>
      </ul>
    </section>

    <!-- Page 2: Device ID -->
    <section id="page2" class="page hidden">
      <h2>Device ID</h2>
      <input type="text" id="deviceIDInput" placeholder="Enter device ID" />
      <button id="setDeviceBtn">Set Device</button>
      <p id="deviceConfirmation" class="hidden success-text"></p>
    </section>

    <!-- Page 3: Live Data -->
    <section id="page3" class="page hidden">
      <h2>Live Data</h2>
      <div class="tips-grid" id="liveGrid"></div>
      <div class="live-meta">
        <p><strong>WiFi Speed:</strong> <span id="wifiSpeed">--</span> ms</p>
      </div>
    </section>

    <!-- Page 4: Set Preferences -->
    <section id="page4" class="page hidden">
      <h2>Set Preferences</h2>

      <!-- Skewer Mode -->
      <div class="mode-bar" role="group" aria-label="Skewer mode">
        <label class="mode-title">Skewer Mode</label>
        <label class="mode-pill">
          <input type="radio" name="skMode" id="modeChicken" value="chicken">
          Chicken (locked Well Done)
        </label>
        <label class="mode-pill">
          <input type="radio" name="skMode" id="modeMeat" value="meat" checked>
          Meat (choose per tip)
        </label>
      </div>

      <p class="note-orange">
        In <strong>Chicken</strong> mode, all tips are fixed to <strong>Chicken ‚Ä¢ Well Done</strong> and per-tip controls are disabled.
        Switch to <strong>Meat</strong> mode to choose meats/doneness per tip or use <em>Apply to All</em>.
      </p>

      <!-- Apply-to-all controls (Meat mode only) -->
      <div class="bulk-controls">
        <label class="bulk-label">Apply to all tips</label>
        <select id="bulkMeat"></select>
        <select id="bulkDone"></select>
        <button id="bulkApplyBtn" class="btn-apply" disabled>Apply to all</button>
      </div>

      <div class="tips-grid" id="prefsGrid"></div>

      <div class="buttons">
        <button id="startAllBtn" class="btn-start" disabled>Start (All)</button>
        <button id="stopAllBtn" class="btn-stop" disabled>Stop (All)</button>
      </div>

      <p id="confirmation" class="hidden success-text"></p>
    </section>
  </div>

  <!-- Cooking Complete Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <h3 id="modalTitle">Cooking Complete</h3>
      <p id="modalMsg">Tip X reached target temperature.</p>
      <button id="modalClose" class="btn-primary">Close</button>
    </div>
  </div>

  <!-- ====================== JavaScript (embedded) ====================== -->
  <script type="module">
    /* ---------- Firebase (v10) ---------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // Your config (from your first message)
    const firebaseConfig = {
      apiKey: "AIzaSyCXDxynz9AKrexXIUmvza8xnPA2HriiePQ",
      authDomain: "sos-project-23171.firebaseapp.com",
      databaseURL: "https://sos-project-23171-default-rtdb.firebaseio.com",
      projectId: "sos-project-23171",
      storageBucket: "sos-project-23171.firebasestorage.app",
      messagingSenderId: "739080997565",
      appId: "1:739080997565:web:8794ee9ba4f4f27de4c5d4"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /* ---------- Elements ---------- */
    const menuBtn = document.getElementById("menuToggle");
    const sideMenu = document.getElementById("sideMenu");
    const navLinks = document.querySelectorAll("[data-nav]");

    const deviceInput = document.getElementById("deviceIDInput");
    const setDeviceBtn = document.getElementById("setDeviceBtn");
    const deviceConfirmation = document.getElementById("deviceConfirmation");

    const wifiSpeedSpan = document.getElementById("wifiSpeed");
    const connBanner = document.getElementById("connBanner");
    const liveGrid = document.getElementById("liveGrid");
    const prefsGrid = document.getElementById("prefsGrid");
    const startAllBtn = document.getElementById("startAllBtn");
    const stopAllBtn = document.getElementById("stopAllBtn");
    const confirmText = document.getElementById("confirmation");

    const bulkMeat = document.getElementById("bulkMeat");
    const bulkDone = document.getElementById("bulkDone");
    const bulkApplyBtn = document.getElementById("bulkApplyBtn");

    const modeChicken = document.getElementById("modeChicken");
    const modeMeat = document.getElementById("modeMeat");

    const modal = document.getElementById("modal");
    const modalMsg = document.getElementById("modalMsg");
    const modalClose = document.getElementById("modalClose");

    /* ---------- State & constants ---------- */
    const LS_DEVICE = "sos_device_id";
    const ALL_TIPS = [1,2,3,4,5,6,7,8];
    const TIP_ROWS = [[4,8],[3,7],[2,6],[1,5]];

    const MEATS = [
      "Chicken","Tri tip","Knuckle","Flap","Top round","Top sirloin","Flank",
      "Sirloin cap","Chuck / teres major","Steak cut / strip loin","Rib / ribeye","Flat iron"
    ];
    const NON_CHICKEN_MEATS = MEATS.filter(m => m !== "Chicken");
    const DONENESS = ["Rare","Medium Rare","Medium","Medium Well","Well Done"];

    const BASE_TARGETS = { "Rare":51, "Medium Rare":55, "Medium":60, "Medium Well":67, "Well Done":72 };
    const TARGET_MAP = new Map();
    MEATS.forEach(m => { if (m !== "Chicken") TARGET_MAP.set(m,{...BASE_TARGETS}); });
    TARGET_MAP.set("Chicken", { "Well Done": 74 });

    const SK_MODE = { CHICKEN: 'chicken', MEAT: 'meat' };
    let skewerMode = SK_MODE.MEAT; // until DB says otherwise
    const tipSettings = {};              // { [tip]: { meatType, doneness } }
    const tipCompleteShown = new Set();  // modal once per tip
    let currentDeviceID = null;

    /* ---------- Utils ---------- */
    const show = el => el.classList.remove("hidden");
    const hide = el => el.classList.add("hidden");
    const el  = (t,c)=>{const e=document.createElement(t); if(c)e.className=c; return e;};
    const isChicken = (m) => (m||"").toLowerCase() === "chicken";
    const targetTempFor = (meat,done)=>TARGET_MAP.get(meat)?.[done]||null;
    const toastOk = (msg)=>{ confirmText.textContent = msg; show(confirmText); setTimeout(()=>hide(confirmText),1600); };

    function buildDonenessOptions(sel, selected=null) {
      sel.innerHTML = "";
      DONENESS.forEach(d=>{
        const o=document.createElement("option");
        o.value=d; o.textContent=d;
        if (selected && selected===d) o.selected=true;
        sel.appendChild(o);
      });
    }
    function populateSelect(sel, arr) {
      sel.innerHTML = "";
      arr.forEach(v => {
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      });
    }

    /* ---------- Navigation ---------- */
    menuBtn.addEventListener("click",()=>{
      sideMenu.classList.toggle("hidden");
      sideMenu.setAttribute("aria-hidden", sideMenu.classList.contains("hidden") ? "true":"false");
    });
    navLinks.forEach(link=>{
      link.addEventListener("click",e=>{
        e.preventDefault();
        document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
        document.querySelector(link.getAttribute("href")).classList.remove("hidden");
        sideMenu.classList.add("hidden");
        sideMenu.setAttribute("aria-hidden","true");
      });
    });

    /* ---------- Build Grids ---------- */
    function buildLiveGrid(){
      liveGrid.innerHTML="";
      TIP_ROWS.forEach(([L,R])=>{
        const row=el("div","tips-row");
        [L,R].forEach(t=>{
          const card=el("div","tip-card");
          card.innerHTML=`
            <div class="tip-header">
              <span class="tip-badge">Tip ${t}</span>
              <span class="tip-label"><span id="liveMeat${t}">--</span> ‚Ä¢ <span id="liveDone${t}">--</span></span>
            </div>
            <p class="tip-line"><strong>Temp:</strong> <span id="temp${t}">--</span> ¬∞C</p>
            <p class="tip-line"><strong>Target:</strong> <span id="target${t}">--</span> ¬∞C</p>
            <div class="progress">
              <div id="pbar${t}" class="progress-bar"></div>
              <span id="plabel${t}" class="progress-label">--%</span>
            </div>`;
          row.appendChild(card);
        });
        liveGrid.appendChild(row);
      });
    }

    function buildPrefsGrid(){
      prefsGrid.innerHTML="";
      TIP_ROWS.forEach(([L,R])=>{
        const row=el("div","tips-row");
        [L,R].forEach(t=>{
          const card=el("div","tip-card");
          const header=el("div","tip-header");
          header.innerHTML = `<span class="tip-badge">Tip ${t}</span>`;

          const meatSel=el("select"); meatSel.id=`meat${t}`;
          const doneSel=el("select"); doneSel.id=`done${t}`;
          const btn=el("button","btn-apply"); btn.id=`applyBtn${t}`; btn.textContent="Apply";

          populateSelect(meatSel, MEATS);
          buildDonenessOptions(doneSel, "Medium");

          btn.addEventListener("click", async ()=>{
            if (!currentDeviceID) return alert("Set device first");
            if (skewerMode === SK_MODE.CHICKEN) return alert("Skewer is in Chicken mode. Switch to Meat mode to change tips.");

            const chosenMeat = meatSel.value;
            const chosenDone = isChicken(chosenMeat) ? "Well Done" : doneSel.value;

            await update(ref(db,`devices/${currentDeviceID}/settings/tips/${t}`), { meatType: chosenMeat, doneness: chosenDone });

            tipSettings[t] = { meatType: chosenMeat, doneness: chosenDone };
            document.getElementById(`liveMeat${t}`).textContent = chosenMeat;
            document.getElementById(`liveDone${t}`).textContent = chosenDone;
            document.getElementById(`target${t}`).textContent = targetTempFor(chosenMeat, chosenDone) ?? "--";
            toastOk(`Tip ${t}: ${chosenMeat} ‚Ä¢ ${chosenDone} saved`);
          });

          card.appendChild(header);
          card.appendChild(meatSel);
          card.appendChild(doneSel);
          card.appendChild(btn);
          row.appendChild(card);
        });
        prefsGrid.appendChild(row);
      });
    }

    /* ---------- Mode Handling (no mixing) ---------- */
    function applyModeUI(){
      modeChicken.checked = (skewerMode === SK_MODE.CHICKEN);
      modeMeat.checked    = (skewerMode === SK_MODE.MEAT);

      ALL_TIPS.forEach(t=>{
        const meatSel = document.getElementById(`meat${t}`);
        const doneSel = document.getElementById(`done${t}`);
        const applyBtn= document.getElementById(`applyBtn${t}`);
        if (!meatSel || !doneSel) return;

        if (skewerMode === SK_MODE.CHICKEN) {
          meatSel.innerHTML = `<option value="Chicken">Chicken</option>`;
          meatSel.value = "Chicken";
          meatSel.disabled = true;

          doneSel.innerHTML = "<option value='Well Done'>Well Done</option>";
          doneSel.value = "Well Done";
          doneSel.disabled = true;

          if (applyBtn) applyBtn.disabled = true;

          tipSettings[t] = { meatType: "Chicken", doneness: "Well Done" };
          document.getElementById(`liveMeat${t}`).textContent = "Chicken";
          document.getElementById(`liveDone${t}`).textContent = "Well Done";
          document.getElementById(`target${t}`).textContent = targetTempFor("Chicken","Well Done") ?? "--";
        } else {
          meatSel.disabled = false;
          doneSel.disabled = false;
          if (applyBtn) applyBtn.disabled = false;

          meatSel.innerHTML = "";
          NON_CHICKEN_MEATS.forEach(m=>{
            const o=document.createElement("option");
            o.value=m; o.textContent=m; meatSel.appendChild(o);
          });
          const prev = tipSettings[t]?.meatType;
          if (prev && NON_CHICKEN_MEATS.includes(prev)) meatSel.value = prev;
          buildDonenessOptions(doneSel, tipSettings[t]?.doneness || "Medium");
        }
      });

      // Bulk controls only in Meat mode
      if (skewerMode === SK_MODE.CHICKEN) {
        bulkApplyBtn.disabled = true;
        bulkMeat.innerHTML = `<option value="Chicken">Chicken</option>`;
        bulkDone.innerHTML = "<option value='Well Done'>Well Done</option>";
        bulkMeat.disabled = true; bulkDone.disabled = true;
      } else {
        bulkMeat.disabled = false; bulkDone.disabled = false; bulkApplyBtn.disabled = false;
        populateSelect(bulkMeat, NON_CHICKEN_MEATS);
        populateSelect(bulkDone, DONENESS);
      }
    }

    async function setMode(mode){
      if (!currentDeviceID) return alert("Set device first");
      if (mode !== SK_MODE.CHICKEN && mode !== SK_MODE.MEAT) return;

      const payload = {};
      payload[`devices/${currentDeviceID}/settings/skewerMode`] = mode;

      if (mode === SK_MODE.CHICKEN) {
        ALL_TIPS.forEach(t=>{
          payload[`devices/${currentDeviceID}/settings/tips/${t}/meatType`] = "Chicken";
          payload[`devices/${currentDeviceID}/settings/tips/${t}/doneness`] = "Well Done";
        });
      }

      await update(ref(db), payload);
      skewerMode = mode;
      applyModeUI();
      toastOk(mode === SK_MODE.CHICKEN
        ? "Skewer set to Chicken mode (all tips locked)."
        : "Skewer set to Meat mode (per-tip choices enabled).");
    }

    modeChicken.addEventListener("change",(e)=>{ if (e.target.checked) setMode(SK_MODE.CHICKEN); });
    modeMeat.addEventListener("change",(e)=>{ if (e.target.checked) setMode(SK_MODE.MEAT); });

    /* ---------- Apply to All (Meat mode only) ---------- */
    bulkApplyBtn.addEventListener("click", async ()=>{
      if (!currentDeviceID) return alert("Set device first");
      if (skewerMode === SK_MODE.CHICKEN) return alert("Apply to All is only available in Meat mode.");

      const meat = bulkMeat.value;
      const done = bulkDone.value;

      // 1) Write once to Firebase
      const payload = {};
      ALL_TIPS.forEach(t=>{
        payload[`devices/${currentDeviceID}/settings/tips/${t}/meatType`] = meat;
        payload[`devices/${currentDeviceID}/settings/tips/${t}/doneness`] = done;
      });
      await update(ref(db), payload);

      // 2) Immediate UI sync across BOTH pages (no waiting on onValue echoes)
      ALL_TIPS.forEach(t=>{
        // Set Preferences selects
        const meatSel = document.getElementById(`meat${t}`);
        const doneSel = document.getElementById(`done${t}`);
        if (meatSel) meatSel.value = meat;
        if (doneSel) {
          doneSel.disabled = false;
          buildDonenessOptions(doneSel, done);
        }
        // Local state + Live labels/targets
        tipSettings[t] = { meatType: meat, doneness: done };
        document.getElementById(`liveMeat${t}`).textContent = meat;
        document.getElementById(`liveDone${t}`).textContent = done;
        document.getElementById(`target${t}`).textContent = targetTempFor(meat, done) ?? "--";
      });

      toastOk(`Applied to all tips: ${meat} ‚Ä¢ ${done}`);
    });

    /* ---------- Start/Stop (update Firebase) ---------- */
    startAllBtn.addEventListener("click", async ()=>{
      if (!currentDeviceID) return;
      tipCompleteShown.clear();
      await update(ref(db,`devices/${currentDeviceID}/settings`), { command: "start" });
      // Jump to Live page
      document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
      document.getElementById("page3").classList.remove("hidden");
      toastOk("üî• Cooking started");
    });

    stopAllBtn.addEventListener("click", async ()=>{
      if (!currentDeviceID) return;
      tipCompleteShown.clear();
      await update(ref(db,`devices/${currentDeviceID}/settings`), { command: "stop" });
      toastOk("üõë Cooking stopped");
    });

    /* ---------- Firebase Listeners ---------- */
    function subscribeDevice(id){
      // Connection
      onValue(ref(db,`devices/${id}/liveData/isConnected`), s=>{
        const ok = !!s.val();
        if (ok) {
          hide(connBanner);
          document.body.classList.remove('has-banner');
          startAllBtn.disabled=false; stopAllBtn.disabled=false;
          bulkApplyBtn.disabled = (skewerMode===SK_MODE.CHICKEN);
        } else {
          show(connBanner);
          document.body.classList.add('has-banner');
          startAllBtn.disabled=true; stopAllBtn.disabled=true;
        }
      });

      // Optional RTT
      onValue(ref(db,`devices/${id}/liveData/wifiSpeed`), s=>{
        wifiSpeedSpan.textContent = s.val() ?? "--";
      });

      // Mode
      onValue(ref(db,`devices/${id}/settings/skewerMode`), s=>{
        const v = s.val();
        if (v === SK_MODE.CHICKEN || v === SK_MODE.MEAT) {
          skewerMode = v;
          modeChicken.checked = (v===SK_MODE.CHICKEN);
          modeMeat.checked    = (v===SK_MODE.MEAT);
          applyModeUI();
        }
      });

      // Settings & Live temps
      ALL_TIPS.forEach(t=>{
        onValue(ref(db,`devices/${id}/settings/tips/${t}`), s=>{
          const v = s.val() || {};
          const meat = v.meatType || "--";
          const done = v.doneness || "--";
          tipSettings[t] = { meatType: meat, doneness: done };

          // Live labels + target
          document.getElementById(`liveMeat${t}`).textContent = meat;
          document.getElementById(`liveDone${t}`).textContent = done;
          document.getElementById(`target${t}`).textContent = targetTempFor(meat,done) ?? "--";

          // Reflect into Set Preferences (keeps UI synced even if updated elsewhere)
          const meatSel=document.getElementById(`meat${t}`);
          const doneSel=document.getElementById(`done${t}`);
          if (skewerMode === SK_MODE.MEAT) {
            if (meatSel && NON_CHICKEN_MEATS.includes(meat)) meatSel.value = meat;
            if (doneSel) { doneSel.disabled = false; buildDonenessOptions(doneSel, DONENESS.includes(done) ? done : "Medium"); }
          }
        });

        onValue(ref(db,`devices/${id}/liveData/tips/${t}/temperature`), s=>{
          const temp = Number(s.val() ?? NaN);
          if (!Number.isFinite(temp)) return;

          document.getElementById(`temp${t}`).textContent = temp.toFixed(1);

          const { meatType, doneness } = tipSettings[t] || {};
          const tgt = targetTempFor(meatType, doneness);
          const bar = document.getElementById(`pbar${t}`);
          const lab = document.getElementById(`plabel${t}`);

          if (bar && lab && tgt) {
            const pct = Math.max(0, Math.min(100, Math.round((temp / tgt) * 100)));
            bar.style.width = pct + "%";
            lab.textContent = pct + "%";

            if (temp >= tgt && !tipCompleteShown.has(t)) {
              tipCompleteShown.add(t);
              openModal(`Tip ${t} reached target temperature (${tgt}¬∞C).`);
            }
          } else if (bar && lab) {
            bar.style.width = "0%";
            lab.textContent = "--%";
          }
        });
      });
    }

    /* ---------- Device Handling ---------- */
    async function setCurrentDevice(id){
      currentDeviceID=id; localStorage.setItem(LS_DEVICE,id);
      deviceConfirmation.textContent=`Device set: ${id}`; show(deviceConfirmation);
      subscribeDevice(id);
    }

    setDeviceBtn.addEventListener("click", async ()=>{
      const id=(deviceInput.value||"").trim();
      if (!id) return alert("Enter device ID");
      const snap = await get(ref(db,`devices/${id}`));
      if (!snap.exists()) return alert("Device not found");
      setCurrentDevice(id);
    });

    // Auto-connect last device
    const saved = localStorage.getItem(LS_DEVICE);
    if (saved) {
      deviceInput.value = saved;
      get(ref(db,`devices/${saved}`)).then(s=>{ if(s.exists()) setCurrentDevice(saved); });
    }

    /* ---------- Modal ---------- */
    function openModal(msg){ modalMsg.textContent = msg; show(modal); }
    modalClose.addEventListener("click",()=>hide(modal));
    modal.addEventListener("click",(e)=>{ if(e.target === modal) hide(modal); });
    document.addEventListener("keydown",(e)=>{ if(e.key === "Escape") hide(modal); });

    /* ---------- Bootstrap ---------- */
    function buildUI(){
      buildLiveGrid();
      buildPrefsGrid();
      // Defaults before DB echoes
      ALL_TIPS.forEach(t=>{
        tipSettings[t] = { meatType: "Tri tip", doneness: "Medium" };
        document.getElementById(`liveMeat${t}`).textContent = "Tri tip";
        document.getElementById(`liveDone${t}`).textContent = "Medium";
        document.getElementById(`target${t}`).textContent = targetTempFor("Tri tip","Medium") ?? "--";
      });
      applyModeUI();
    }
    buildUI();
  </script>
</body>
</html>
