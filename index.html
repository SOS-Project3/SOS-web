<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOS BBQ Monitor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ESP disconnect banner -->
  <div id="connBanner" class="banner hidden">‚ö†Ô∏è ESP disconnected</div>

  <!-- Hamburger navigation -->
  <button id="menuToggle" class="hamburger" aria-label="Open navigation">
    <span></span><span></span><span></span>
  </button>

  <nav id="sideMenu" class="side-menu hidden" aria-hidden="true">
    <ul>
      <li><a href="#page1" data-nav>1) Project Description</a></li>
      <li><a href="#page2" data-nav>2) Device ID</a></li>
      <li><a href="#page3" data-nav>3) Live Data</a></li>
      <li><a href="#page4" data-nav>4) Set Preferences</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- Page 1 -->
    <section id="page1" class="page active">
      <h1>SOS BBQ MONITOR</h1>
      <p><strong>SOS: Smart Oven & Skewer</strong> ‚Äî monitor and control an 8-tip skewer powered by ESP32 + Firebase. Set per-tip meat & doneness, see live temps, and track progress to target.</p>
    </section>

    <!-- Page 2: Device ID -->
    <section id="page2" class="page hidden">
      <h2>Device ID</h2>
      <input type="text" id="deviceIDInput" placeholder="Enter device ID" />
      <button id="setDeviceBtn">Set Device</button>
      <p id="deviceConfirmation" class="hidden success-text"></p>
    </section>

    <!-- Page 3: Live Data (4-4 layout) -->
    <section id="page3" class="page hidden">
      <h2>Live Data</h2>
      <div class="tips-grid" id="liveGrid">
        <!-- JS renders tip cards in rows:
             [ [4,8], [3,7], [2,6], [1,5] ] -->
      </div>
      <div class="live-meta">
        <p><strong>WiFi Speed:</strong> <span id="wifiSpeed">--</span> ms</p>
      </div>
    </section>

    <!-- Page 4: Set Preferences (4-4 layout) -->
    <section id="page4" class="page hidden">
      <h2>Set Preferences</h2>
      <p class="note-orange" id="chickenNote">Chicken is always cooked Well Done.</p>

      <div class="tips-grid" id="prefsGrid">
        <!-- JS renders per-tip preference cards with selects and Apply -->
      </div>

      <div class="buttons">
        <button id="startAllBtn" class="btn-start" disabled>Start Cooking (All)</button>
        <button id="stopAllBtn" class="btn-stop" disabled>Stop (All)</button>
      </div>
      <p id="confirmation" class="hidden success-text"></p>
    </section>
  </div>

  <!-- Cooking Complete Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <h3 id="modalTitle">Cooking Complete</h3>
      <p id="modalMsg">Tip X reached target temperature.</p>
      <button id="modalClose" class="btn-primary">Close</button>
    </div>
  </div>

  <!-- JavaScript (module) -->
  <script type="module">
    /* ---------------- Firebase ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXDxynz9AKrexXIUmvza8xnPA2HriiePQ",
      authDomain: "sos-project-23171.firebaseapp.com",
      databaseURL: "https://sos-project-23171-default-rtdb.firebaseio.com",
      projectId: "sos-project-23171",
      storageBucket: "sos-project-23171.firebasestorage.app",
      messagingSenderId: "739080997565",
      appId: "1:739080997565:web:8794ee9ba4f4f27de4c5d4"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ---------------- DOM refs ---------------- */
    const menuBtn = document.getElementById("menuToggle");
    const sideMenu = document.getElementById("sideMenu");
    const navLinks = document.querySelectorAll("[data-nav]");

    const deviceInput = document.getElementById("deviceIDInput");
    const setDeviceBtn = document.getElementById("setDeviceBtn");
    const deviceConfirmation = document.getElementById("deviceConfirmation");

    const wifiSpeedSpan = document.getElementById("wifiSpeed");
    const connBanner = document.getElementById("connBanner");

    const liveGrid = document.getElementById("liveGrid");
    const prefsGrid = document.getElementById("prefsGrid");

    const startAllBtn = document.getElementById("startAllBtn");
    const stopAllBtn = document.getElementById("stopAllBtn");
    const confirmText = document.getElementById("confirmation");

    const modal = document.getElementById("modal");
    const modalMsg = document.getElementById("modalMsg");
    const modalClose = document.getElementById("modalClose");

    /* ---------------- State ---------------- */
    const LS_DEVICE = "sos_device_id";
    let currentDeviceID = null;

    // display order rows: [ [left, right], ... ]
    const TIP_ROWS = [[4,8],[3,7],[2,6],[1,5]];
    const ALL_TIPS = [1,2,3,4,5,6,7,8];

    // Targets from your ESP struct
    const MEATS = [
      "Chicken",
      "Tri tip","Knuckle","Flap","Top round","Top sirloin","Flank",
      "Sirloin cap","Chuck / teres major","Steak cut / strip loin","Rib / ribeye","Flat iron"
    ];
    const DONENESS = ["Rare","Medium Rare","Medium","Medium Well","Well Done"];
    const BASE_TARGETS = { "Rare":51, "Medium Rare":55, "Medium":60, "Medium Well":67, "Well Done":72 };
    const TARGET_MAP = new Map();
    // Fill beef-like meats with base targets
    MEATS.forEach(m => {
      if (m !== "Chicken") TARGET_MAP.set(m, { ...BASE_TARGETS });
    });
    // Chicken only Well Done 74
    TARGET_MAP.set("Chicken", { "Well Done": 74 });

    // per-tip cached settings (from Firebase) to compute targets on Live page
    const tipSettings = {}; // { tipNum: { meatType, doneness } }
    const tipCompleteShown = new Set(); // avoid duplicate modals

    /* ---------------- Helpers ---------------- */
    const $ = (sel, root=document) => root.querySelector(sel);
    const el = (tag, cls) => { const e = document.createElement(tag); if (cls) e.className = cls; return e; };
    const show = (n) => n.classList.remove("hidden");
    const hide = (n) => n.classList.add("hidden");

    function targetTempFor(meat, done) {
      const m = TARGET_MAP.get(meat);
      if (!m) return null;
      return m[done] ?? null;
    }

    function updateProgressBar(barEl, labelEl, current, target) {
      if (!target || target <= 0) {
        barEl.style.width = "0%";
        labelEl.textContent = "--%";
        return;
      }
      let pct = Math.max(0, Math.min(100, Math.round((current / target) * 100)));
      barEl.style.width = pct + "%";
      labelEl.textContent = pct + "%";
    }

    function openModal(msg) { modalMsg.textContent = msg; show(modal); }
    modalClose.addEventListener("click", () => hide(modal));

    function toastOk(text) {
      confirmText.textContent = text;
      show(confirmText);
      setTimeout(() => hide(confirmText), 2000);
    }

    /* ---------------- Navigation ---------------- */
    menuBtn.addEventListener("click", () => sideMenu.classList.toggle("hidden"));
    navLinks.forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
        const target = document.querySelector(a.getAttribute("href"));
        document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
        target.classList.remove("hidden");
        sideMenu.classList.add("hidden");
      });
    });

    /* ---------------- Build UI grids ---------------- */
    function buildLiveGrid() {
      liveGrid.innerHTML = "";
      TIP_ROWS.forEach(([L,R]) => {
        const row = el("div","tips-row");
        // left card
        row.appendChild(liveTipCard(L));
        // right card
        row.appendChild(liveTipCard(R));
        liveGrid.appendChild(row);
      });
    }

    function liveTipCard(tipNum) {
      const card = el("div","tip-card");
      const header = el("div","tip-header");
      header.innerHTML = `<span class="tip-badge">Tip ${tipNum}</span>
                          <span class="tip-meat" id="liveMeat${tipNum}">--</span>
                          <span class="tip-done" id="liveDone${tipNum}">--</span>`;
      const tempP = el("p","tip-temp");
      tempP.innerHTML = `<strong>Temp:</strong> <span id="temp${tipNum}">--</span> ¬∞C`;

      const targetP = el("p","tip-target");
      targetP.innerHTML = `<strong>Target:</strong> <span id="target${tipNum}">--</span> ¬∞C`;

      const prog = el("div","progress");
      const bar = el("div","progress-bar");
      const label = el("span","progress-label");
      prog.appendChild(bar); prog.appendChild(label);
      bar.id = `pbar${tipNum}`; label.id = `plabel${tipNum}`;

      card.appendChild(header);
      card.appendChild(tempP);
      card.appendChild(targetP);
      card.appendChild(prog);
      return card;
    }

    function buildPrefsGrid() {
      prefsGrid.innerHTML = "";
      TIP_ROWS.forEach(([L,R]) => {
        const row = el("div","tips-row");
        row.appendChild(prefTipCard(L));
        row.appendChild(prefTipCard(R));
        prefsGrid.appendChild(row);
      });
    }

    function prefTipCard(tipNum) {
      const card = el("div","tip-card");
      const header = el("div","tip-header");
      header.innerHTML = `<span class="tip-badge">Tip ${tipNum}</span>`;

      // Meat select
      const meatLabel = el("label"); meatLabel.textContent = "Meat";
      meatLabel.setAttribute("for",`meat${tipNum}`);
      const meatSelect = el("select"); meatSelect.id = `meat${tipNum}`;
      MEATS.forEach(m => {
        const opt = el("option"); opt.value = m; opt.textContent = m; meatSelect.appendChild(opt);
      });

      // Doneness select
      const doneLabel = el("label"); doneLabel.textContent = "Doneness";
      doneLabel.setAttribute("for",`done${tipNum}`);
      const doneSelect = el("select"); doneSelect.id = `done${tipNum}`;
      DONENESS.forEach(d => {
        const opt = el("option"); opt.value = d; opt.textContent = d; doneSelect.appendChild(opt);
      });

      // Apply button
      const applyBtn = el("button","btn-apply"); applyBtn.textContent = "Apply";
      applyBtn.addEventListener("click", async () => {
        if (!currentDeviceID) { alert("Set device first"); return; }
        const meat = meatSelect.value;
        const done = (meat === "Chicken") ? "Well Done" : doneSelect.value;
        if (meat !== "Chicken" && !done) { alert("Select doneness"); return; }

        try {
          await update(ref(db, `devices/${currentDeviceID}/settings/tips/${tipNum}`), {
            meatType: meat, doneness: done
          });
          toastOk(`Tip ${tipNum}: ${meat} - ${done} saved`);
        } catch (e) {
          alert("Error: " + e.message);
        }
      });

      // Chicken rule
      meatSelect.addEventListener("change", () => {
        if (meatSelect.value === "Chicken") {
          doneSelect.value = "Well Done";
          doneSelect.disabled = true;
        } else {
          doneSelect.disabled = false;
        }
      });

      // assemble
      card.appendChild(header);
      card.appendChild(meatLabel); card.appendChild(meatSelect);
      card.appendChild(doneLabel); card.appendChild(doneSelect);
      card.appendChild(applyBtn);
      return card;
    }

    /* ---------------- Device handling ---------------- */
    function enableControls(enabled) {
      startAllBtn.disabled = !enabled;
      stopAllBtn.disabled = !enabled;
      // prefs selects/buttons are always present; user can press Apply any time once device is set
    }

    async function setCurrentDevice(id) {
      currentDeviceID = id;
      localStorage.setItem(LS_DEVICE, id);
      deviceConfirmation.textContent = `Device set: ${id}`;
      deviceConfirmation.classList.remove("hidden");
      enableControls(true);
      subscribeDevice(id);
      preloadTipSettings(id); // hydrate selects
    }

    setDeviceBtn?.addEventListener("click", async () => {
      const id = (deviceInput.value || "").trim();
      if (!id) { alert("Enter a device ID"); return; }
      try {
        const snap = await get(ref(db, `devices/${id}`));
        if (!snap.exists()) { alert("Device not found in Firebase"); return; }
        await setCurrentDevice(id);
      } catch (e) { alert("Error: " + e.message); }
    });

    // Auto-connect if saved
    const saved = localStorage.getItem(LS_DEVICE);
    if (saved) {
      deviceInput && (deviceInput.value = saved);
      get(ref(db, `devices/${saved}`)).then(s => { if (s.exists()) setCurrentDevice(saved); });
    }

    /* ---------------- Firebase subscriptions ---------------- */
    function subscribeDevice(deviceID) {
      // Connection & wifi
      onValue(ref(db, `devices/${deviceID}/liveData/isConnected`), s => {
        const ok = !!s.val();
        ok ? hide(connBanner) : show(connBanner);
      });
      onValue(ref(db, `devices/${deviceID}/liveData/wifiSpeed`), s => {
        wifiSpeedSpan.textContent = s.val() ?? "--";
      });

      // Tip temperatures
      ALL_TIPS.forEach(t => {
        onValue(ref(db, `devices/${deviceID}/liveData/tips/${t}/temperature`), s => {
          const temp = Number(s.val() ?? 0);
          const tempSpan = document.getElementById(`temp${t}`);
          if (tempSpan) tempSpan.textContent = isNaN(temp) ? "--" : temp.toFixed(1);

          const setting = tipSettings[t];
          const tgt = setting ? targetTempFor(setting.meatType, setting.doneness) : null;
          const pbar = document.getElementById(`pbar${t}`);
          const plabel = document.getElementById(`plabel${t}`);
          if (pbar && plabel && tgt) {
            updateProgressBar(pbar, plabel, temp, tgt);
            if (temp >= tgt && !tipCompleteShown.has(t)) {
              tipCompleteShown.add(t);
              openModal(`Tip ${t} reached target temperature (${tgt}¬∞C).`);
            }
          }
        });
      });

      // Tip settings (meat/doneness)
      ALL_TIPS.forEach(t => {
        onValue(ref(db, `devices/${deviceID}/settings/tips/${t}`), s => {
          const val = s.val() || {};
          const meat = val.meatType || "--";
          const done = val.doneness || "--";
          tipSettings[t] = { meatType: meat, doneness: done };

          // reflect on Live cards
          const lm = document.getElementById(`liveMeat${t}`);
          const ld = document.getElementById(`liveDone${t}`);
          const tgtSpan = document.getElementById(`target${t}`);
          if (lm) lm.textContent = meat;
          if (ld) ld.textContent = done;
          if (tgtSpan) {
            const tgt = targetTempFor(meat, done);
            tgtSpan.textContent = tgt ? tgt.toString() : "--";
          }

          // reflect on Prefs selects
          const meatSel = document.getElementById(`meat${t}`);
          const doneSel = document.getElementById(`done${t}`);
          if (meatSel && MEATS.includes(meat)) meatSel.value = meat;
          if (doneSel) {
            if (meat === "Chicken") {
              doneSel.value = "Well Done";
              doneSel.disabled = true;
            } else {
              doneSel.disabled = false;
              if (DONENESS.includes(done)) doneSel.value = done;
            }
          }
        });
      });
    }

    async function preloadTipSettings(deviceID) {
      const snap = await get(ref(db, `devices/${deviceID}/settings/tips`));
      const tips = snap.val() || {};
      ALL_TIPS.forEach(t => {
        const s = tips[t] || {};
        tipSettings[t] = { meatType: s.meatType || "Tri tip", doneness: s.doneness || "Medium" };
      });
    }

    /* ---------------- Global Start/Stop ---------------- */
    startAllBtn.addEventListener("click", async () => {
      if (!currentDeviceID) { alert("Set device first"); return; }
      // send command start
      await update(ref(db, `devices/${currentDeviceID}/settings`), { command: "start" });
      tipCompleteShown.clear(); // new session
      // redirect to Live
      document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
      document.getElementById("page3").classList.remove("hidden");
      toastOk("üî• Cooking started for all tips");
    });

    stopAllBtn.addEventListener("click", async () => {
      if (!currentDeviceID) return;
      await update(ref(db, `devices/${currentDeviceID}/settings`), { command: "stop" });
      toastOk("üõë Stopped (all tips)");
    });

    /* ---------------- Initial build ---------------- */
    buildLiveGrid();
    buildPrefsGrid();
  </script>
</body>
</html>
