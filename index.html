<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOS BBQ Monitor</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- ESP disconnect banner -->
  <div id="connBanner" class="banner hidden">‚ö†Ô∏è ESP disconnected</div>

  <!-- Hamburger navigation -->
  <button id="menuToggle" class="hamburger" aria-label="Open navigation">
    <span></span><span></span><span></span>
  </button>

  <nav id="sideMenu" class="side-menu hidden" aria-hidden="true">
    <ul>
      <li><a href="#page1" data-nav>1) Project Description</a></li>
      <li><a href="#page2" data-nav>2) Device ID</a></li>
      <li><a href="#page3" data-nav>3) Live Data</a></li>
      <li><a href="#page4" data-nav>4) Set Preferences</a></li>
    </ul>
  </nav>

  <div class="container">
    <!-- Page 1 -->
    <section id="page1" class="page active">
      <h1>SOS BBQ MONITOR</h1>
      <p><strong>SOS: Smart Oven & Skewer</strong> ‚Äî monitor and control an 8-tip skewer powered by ESP32 + Firebase. Set per-tip meat & doneness, see live temps, and track progress to target.</p>
    </section>

    <!-- Page 2: Device ID -->
    <section id="page2" class="page hidden">
      <h2>Device ID</h2>
      <input type="text" id="deviceIDInput" placeholder="Enter device ID" />
      <button id="setDeviceBtn">Set Device</button>
      <p id="deviceConfirmation" class="hidden success-text"></p>
    </section>

    <!-- Page 3: Live Data -->
    <section id="page3" class="page hidden">
      <h2>Live Data</h2>
      <div class="tips-grid" id="liveGrid"></div>
      <div class="live-meta">
        <p><strong>WiFi Speed:</strong> <span id="wifiSpeed">--</span> ms</p>
      </div>
    </section>

    <!-- Page 4: Set Preferences -->
    <section id="page4" class="page hidden">
      <h2>Set Preferences</h2>
      <p class="note-orange" id="chickenNote">Chicken is always cooked Well Done.</p>
      <div class="tips-grid" id="prefsGrid"></div>
      <div class="buttons">
        <button id="startAllBtn" class="btn-start" disabled>Start Cooking (All)</button>
        <button id="stopAllBtn" class="btn-stop" disabled>Stop (All)</button>
      </div>
      <p id="confirmation" class="hidden success-text"></p>
    </section>
  </div>

  <!-- Cooking Complete Modal -->
  <div id="modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <h3 id="modalTitle">Cooking Complete</h3>
      <p id="modalMsg">Tip X reached target temperature.</p>
      <button id="modalClose" class="btn-primary">Close</button>
    </div>
  </div>

  <!-- JavaScript -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXDxynz9AKrexXIUmvza8xnPA2HriiePQ",
      authDomain: "sos-project-23171.firebaseapp.com",
      databaseURL: "https://sos-project-23171-default-rtdb.firebaseio.com",
      projectId: "sos-project-23171",
      storageBucket: "sos-project-23171.firebasestorage.app",
      messagingSenderId: "739080997565",
      appId: "1:739080997565:web:8794ee9ba4f4f27de4c5d4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* -------- Elements -------- */
    const menuBtn = document.getElementById("menuToggle");
    const sideMenu = document.getElementById("sideMenu");
    const navLinks = document.querySelectorAll("[data-nav]");
    const deviceInput = document.getElementById("deviceIDInput");
    const setDeviceBtn = document.getElementById("setDeviceBtn");
    const deviceConfirmation = document.getElementById("deviceConfirmation");
    const wifiSpeedSpan = document.getElementById("wifiSpeed");
    const connBanner = document.getElementById("connBanner");
    const liveGrid = document.getElementById("liveGrid");
    const prefsGrid = document.getElementById("prefsGrid");
    const startAllBtn = document.getElementById("startAllBtn");
    const stopAllBtn = document.getElementById("stopAllBtn");
    const confirmText = document.getElementById("confirmation");
    const modal = document.getElementById("modal");
    const modalMsg = document.getElementById("modalMsg");
    const modalClose = document.getElementById("modalClose");

    /* -------- State & constants -------- */
    const LS_DEVICE = "sos_device_id";
    const ALL_TIPS = [1,2,3,4,5,6,7,8];
    const TIP_ROWS = [[4,8],[3,7],[2,6],[1,5]]; // visual 4‚Äì4 mapping

    const MEATS = [
      "Chicken","Tri tip","Knuckle","Flap","Top round","Top sirloin","Flank",
      "Sirloin cap","Chuck / teres major","Steak cut / strip loin","Rib / ribeye","Flat iron"
    ];
    const DONENESS = ["Rare","Medium Rare","Medium","Medium Well","Well Done"];

    // Targets from your ESP struct
    const BASE_TARGETS = { "Rare":51, "Medium Rare":55, "Medium":60, "Medium Well":67, "Well Done":72 };
    const TARGET_MAP = new Map();
    MEATS.forEach(m => { if (m !== "Chicken") TARGET_MAP.set(m,{...BASE_TARGETS}); });
    TARGET_MAP.set("Chicken", { "Well Done": 74 });

    const tipSettings = {};           // { tip#: { meatType, doneness } }
    const tipCompleteShown = new Set(); // modal once per tip
    let currentDeviceID = null;

    const show = el => el.classList.remove("hidden");
    const hide = el => el.classList.add("hidden");
    const el = (t,c)=>{const e=document.createElement(t); if(c)e.className=c; return e;};
    const targetTempFor = (meat,done)=>TARGET_MAP.get(meat)?.[done]||null;

    /* -------- Chicken UI Lock (Frontend-only) -------- */
    const isChicken = (m) => (m || "").toLowerCase() === "chicken";
    function enforceChickenUI(meatSel, doneSel) {
      if (!meatSel || !doneSel) return;
      if (isChicken(meatSel.value)) {
        doneSel.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "Well Done"; opt.textContent = "Well Done";
        doneSel.appendChild(opt);
        doneSel.value = "Well Done";
        doneSel.disabled = true;   // lock
      } else {
        const current = doneSel.value;
        doneSel.disabled = false;  // unlock
        doneSel.innerHTML = "";
        DONENESS.forEach(d => {
          const o = document.createElement("option");
          o.value = d; o.textContent = d;
          doneSel.appendChild(o);
        });
        if (DONENESS.includes(current)) doneSel.value = current;
      }
    }

    /* -------- Navigation -------- */
    menuBtn.addEventListener("click",()=>sideMenu.classList.toggle("hidden"));
    navLinks.forEach(link=>{
      link.addEventListener("click",e=>{
        e.preventDefault();
        document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
        document.querySelector(link.getAttribute("href")).classList.remove("hidden");
        sideMenu.classList.add("hidden");
      });
    });

    /* -------- Modal Close Logic -------- */
    function openModal(msg){ modalMsg.textContent = msg; show(modal); }
    modalClose.addEventListener("click",()=>hide(modal));
    modal.addEventListener("click",(e)=>{ if(e.target === modal) hide(modal); });
    document.addEventListener("keydown",(e)=>{ if(e.key === "Escape") hide(modal); });

    function toastOk(msg){ confirmText.textContent = msg; show(confirmText); setTimeout(()=>hide(confirmText),2000); }

    /* -------- Build Grids (4‚Äì4 layout) -------- */
    function buildLiveGrid(){
      liveGrid.innerHTML="";
      TIP_ROWS.forEach(([L,R])=>{
        const row=el("div","tips-row");
        [L,R].forEach(t=>{
          const card=el("div","tip-card");
          card.innerHTML=`
            <div class="tip-header"><span class="tip-badge">Tip ${t}</span>
              <span id="liveMeat${t}">--</span> - <span id="liveDone${t}">--</span>
            </div>
            <p><strong>Temp:</strong> <span id="temp${t}">--</span> ¬∞C</p>
            <p><strong>Target:</strong> <span id="target${t}">--</span> ¬∞C</p>
            <div class="progress">
              <div id="pbar${t}" class="progress-bar"></div>
              <span id="plabel${t}" class="progress-label">--%</span>
            </div>`;
          row.appendChild(card);
        });
        liveGrid.appendChild(row);
      });
    }

    function buildPrefsGrid(){
      prefsGrid.innerHTML="";
      TIP_ROWS.forEach(([L,R])=>{
        const row=el("div","tips-row");
        [L,R].forEach(t=>{
          const card=el("div","tip-card");
          const header=el("div","tip-header");
          header.innerHTML = `<span class="tip-badge">Tip ${t}</span>`;
          const meatSel=el("select"); meatSel.id=`meat${t}`;
          MEATS.forEach(m=>{const o=el("option");o.value=m;o.textContent=m;meatSel.appendChild(o);});
          const doneSel=el("select"); doneSel.id=`done${t}`;
          DONENESS.forEach(d=>{const o=el("option");o.value=d;o.textContent=d;doneSel.appendChild(o);});

          // Enforce Chicken lock (UI only): on change + on init
          meatSel.addEventListener("change",()=>enforceChickenUI(meatSel,doneSel));
          enforceChickenUI(meatSel,doneSel);

          const btn=el("button","btn-apply"); btn.textContent="Apply";
          btn.addEventListener("click", async ()=>{
            if (!currentDeviceID) return alert("Set device first");
            const meat = meatSel.value;
            const done = isChicken(meat) ? "Well Done" : doneSel.value; // UI-only enforcement mirrored on save
            await update(ref(db,`devices/${currentDeviceID}/settings/tips/${t}`), { meatType: meat, doneness: done });
            toastOk(`Tip ${t}: ${meat} - ${done} saved`);
          });

          const l1=el("label"); l1.textContent="Meat";
          const l2=el("label"); l2.textContent="Doneness";
          card.appendChild(header);
          card.appendChild(l1); card.appendChild(meatSel);
          card.appendChild(l2); card.appendChild(doneSel);
          card.appendChild(btn);
          row.appendChild(card);
        });
        prefsGrid.appendChild(row);
      });
    }

    buildLiveGrid();
    buildPrefsGrid();

    /* -------- Device Handling -------- */
    async function setCurrentDevice(id){
      currentDeviceID=id; localStorage.setItem(LS_DEVICE,id);
      deviceConfirmation.textContent=`Device set: ${id}`; show(deviceConfirmation);
      startAllBtn.disabled=false; stopAllBtn.disabled=false;
      subscribeDevice(id);
    }

    setDeviceBtn.addEventListener("click", async ()=>{
      const id=(deviceInput.value||"").trim();
      if (!id) return alert("Enter device ID");
      const snap = await get(ref(db,`devices/${id}`));
      if (!snap.exists()) return alert("Device not found");
      setCurrentDevice(id);
    });

    // Auto-connect to last device
    const saved = localStorage.getItem(LS_DEVICE);
    if (saved) {
      if (deviceInput) deviceInput.value = saved;
      get(ref(db,`devices/${saved}`)).then(s=>{ if(s.exists()) setCurrentDevice(saved); });
    }

    /* -------- Firebase Listeners -------- */
    function subscribeDevice(id){
      // Connection + WiFi
      onValue(ref(db,`devices/${id}/liveData/isConnected`), s => s.val()?hide(connBanner):show(connBanner));
      onValue(ref(db,`devices/${id}/liveData/wifiSpeed`), s => wifiSpeedSpan.textContent = s.val() ?? "--");

      // Tip settings reflect (and enforce UI lock)
      ALL_TIPS.forEach(t=>{
        onValue(ref(db,`devices/${id}/settings/tips/${t}`), s=>{
          const v = s.val() || {};
          const meat = v.meatType || "--";
          const done = v.doneness || "--";
          tipSettings[t] = { meatType: meat, doneness: done };

          // Live labels
          const lm=document.getElementById(`liveMeat${t}`); if(lm) lm.textContent = meat;
          const ld=document.getElementById(`liveDone${t}`); if(ld) ld.textContent = done;
          const tgt=document.getElementById(`target${t}`); if(tgt) tgt.textContent = targetTempFor(meat,done) ?? "--";

          // Prefs selects reflect, then enforce UI lock (frontend only)
          const meatSel=document.getElementById(`meat${t}`);
          const doneSel=document.getElementById(`done${t}`);
          if (meatSel && MEATS.includes(meat)) meatSel.value = meat;

          if (doneSel) {
            // repopulate all doneness first (so Chicken can shrink to 1 option)
            doneSel.innerHTML = "";
            DONENESS.forEach(d=>{const o=document.createElement("option"); o.value=d; o.textContent=d; doneSel.appendChild(o);});
            if (DONENESS.includes(done)) doneSel.value = done;
          }
          if (meatSel && doneSel) enforceChickenUI(meatSel, doneSel);
        });

        // Tip live temperature ‚Üí progress + modal
        onValue(ref(db,`devices/${id}/liveData/tips/${t}/temperature`), s=>{
          const temp = Number(s.val() ?? 0);
          const tempSpan = document.getElementById(`temp${t}`); if (tempSpan) tempSpan.textContent = temp.toFixed(1);

          const { meatType, doneness } = tipSettings[t] || {};
          const tgt = targetTempFor(meatType, doneness);
          const bar = document.getElementById(`pbar${t}`);
          const lab = document.getElementById(`plabel${t}`);
          if (bar && lab && tgt) {
            const pct = Math.min(100, Math.max(0, Math.round((temp / tgt) * 100)));
            bar.style.width = pct + "%";
            lab.textContent = pct + "%";
            if (temp >= tgt && !tipCompleteShown.has(t)) {
              tipCompleteShown.add(t);
              openModal(`Tip ${t} reached target temperature (${tgt}¬∞C).`);
            }
          } else if (bar && lab) {
            bar.style.width = "0%";
            lab.textContent = "--%";
          }
        });
      });
    }

    /* -------- Start/Stop All -------- */
    startAllBtn.addEventListener("click", async ()=>{
      if (!currentDeviceID) return;
      await update(ref(db,`devices/${currentDeviceID}/settings`), { command: "start" });
      tipCompleteShown.clear();
      // Redirect to Live Data
      document.querySelectorAll(".page").forEach(p=>p.classList.add("hidden"));
      document.getElementById("page3").classList.remove("hidden");
      toastOk("üî• Cooking started for all tips");
    });

    stopAllBtn.addEventListener("click", async ()=>{
      if (!currentDeviceID) return;
      await update(ref(db,`devices/${currentDeviceID}/settings`), { command: "stop" });
      toastOk("üõë Cooking stopped");
    });
  </script>
</body>
</html>
